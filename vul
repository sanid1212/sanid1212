import subprocess
import xml.etree.ElementTree as ET
import json

# Function to start a new SQLMap scan
def start_sqlmap_scan(url, data, cookies):
    # Define the SQLMap command with the --proxy option
    command = [
        'sqlmap',
        '--url', url,
        '--data', data,
        '--cookie', cookies,
        '--level', '3',
        '--risk', '2',
        '--proxy', 'http://127.0.0.1:8080'  # Update with your proxy URL
    ]

    # Start the SQLMap scan as a subprocess
    process = subprocess.Popen(command, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    out, err = process.communicate()

    return out, err

# Parse the XML file containing requests
xml_file = "requests.xml"  # Update with your XML file path
tree = ET.parse(xml_file)
root = tree.getroot()

# Iterate through the requests in the XML
for request in root.findall('request'):
    url = request.find('url').text
    data = request.find('data').text
    cookies = request.find('cookies').text

    # Start a new SQLMap scan with the specified proxy
    scan_output, error_output = start_sqlmap_scan(url, data, cookies)

    # Print the output (you can modify this to parse and use the output as needed)
    print("SQLMap Output:")
    print(scan_output.decode('utf-8'))

    if error_output:
        print("SQLMap Error Output:")
        print(error_output.decode('utf-8'))
